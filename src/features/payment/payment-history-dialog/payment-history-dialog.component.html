<div class="dialog-wrapper">
    <!-- Header -->
    <div class="dialog-header">
        <div class="header-content">
            <mat-icon class="header-icon">history</mat-icon>
            <div class="header-text">
                <h2>Payment History</h2>
                <p>Student: <strong>{{data.userName}}</strong></p>
            </div>
        </div>
        <button mat-icon-button mat-dialog-close class="close-btn">
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <!-- Content -->
    <div class="dialog-content">
        <!-- Loading State -->
        <div class="loading-state" *ngIf="isLoading">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading payment history...</p>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="!isLoading && payments.length === 0">
            <mat-icon class="empty-icon">receipt_long</mat-icon>
            <h3>No Payments Found</h3>
            <p>No payment records available for this student.</p>
        </div>

        <!-- Table View -->
        <div class="table-wrapper" *ngIf="!isLoading && payments.length > 0">
            <table mat-table [dataSource]="payments" class="payments-table">
                
                <!-- Date Column -->
                <ng-container matColumnDef="date">
                    <th mat-header-cell *matHeaderCellDef>Date</th>
                    <td mat-cell *matCellDef="let element" class="date-cell">
                        {{element.paymentDate | date:'MMM dd, yyyy'}}
                    </td>
                </ng-container>

                <!-- Month Column -->
                <ng-container matColumnDef="month">
                    <th mat-header-cell *matHeaderCellDef>For Month</th>
                    <td mat-cell *matCellDef="let element" class="month-cell">
                        <span *ngIf="element.paymentType === 'ADVANCE'" class="badge-advance">Security/Advance</span>
                        <span *ngIf="element.paymentType !== 'ADVANCE' && element.forMonth && element.forYear">{{element.forMonth}}/{{element.forYear}}</span>
                        <span *ngIf="element.paymentType !== 'ADVANCE' && !element.forMonth" class="badge-advance">—</span>
                    </td>
                </ng-container>

                <!-- Amount Column -->
                <ng-container matColumnDef="amount">
                    <th mat-header-cell *matHeaderCellDef>Amount</th>
                    <td mat-cell *matCellDef="let element" class="amount-cell">
                        <div class="amount-main">₹{{element.amountPaid | number:'1.2-2'}}</div>
                        <div *ngIf="getExtraAmount(element) > 0" class="amount-extra">
                            +₹{{getExtraAmount(element) | number:'1.2-2'}}
                        </div>
                    </td>
                </ng-container>

                <!-- Notes Column -->
                <ng-container matColumnDef="notes">
                    <th mat-header-cell *matHeaderCellDef>Notes</th>
                    <td mat-cell *matCellDef="let element" class="notes-cell">
                        <span *ngIf="element.notes" class="notes-text" [title]="element.notes">
                            {{element.notes | slice:0:28}}{{element.notes.length > 28 ? '...' : ''}}
                        </span>
                        <span *ngIf="!element.notes" class="no-notes">—</span>
                    </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let element" class="status-cell">
                        <span class="status-badge" [class]="element.status.toLowerCase()">
                            {{element.status}}
                        </span>
                        <div *ngIf="element.refundAmount && element.refundAmount > 0" class="refund-badge">
                            <mat-icon>undo</mat-icon>
                            <span>Refunded: ₹{{element.refundAmount | number:'1.2-2'}}</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                    <td mat-cell *matCellDef="let element" class="actions-cell">
                        <button mat-icon-button 
                                matTooltip="Print Receipt"
                                class="action-btn print-btn"
                                (click)="printReceipt(element)"
                                [disabled]="element.status === 'CANCELLED'">
                            <mat-icon>receipt</mat-icon>
                        </button>
                        <button mat-icon-button 
                                matTooltip="Issue Refund"
                                class="action-btn refund-btn"
                                *ngIf="canShowRefund(element)"
                                (click)="openRefundDialog(element)">
                            <mat-icon>undo</mat-icon>
                        </button>
                        <button mat-icon-button 
                                matTooltip="Cancel Payment"
                                class="action-btn cancel-btn"
                                *ngIf="element.status !== 'CANCELLED' && isLatestPayment(element)"
                                (click)="cancelPayment(element.id)">
                            <mat-icon>delete_forever</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <!-- Table Rows -->
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="payment-row"></tr>
            </table>
        </div>
    </div>
</div>
