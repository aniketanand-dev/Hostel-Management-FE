<div class="dashboard-container animate-fade-in">
    <header class="page-header">
        <div class="header-text">
            <h1>Dashboard Overview</h1>
            <p>Welcome back! Here's what's happening today.</p>
        </div>
        <div class="header-selectors" *ngIf="buildings.length > 0">
            <mat-form-field appearance="outline" class="building-select">
                <mat-label>Select Building</mat-label>
                <mat-select [value]="selectedBuildingId" (selectionChange)="onBuildingChange($event)">
                    <mat-option *ngFor="let building of buildings" [value]="building.id">
                        {{building.buildingName}}
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </div>
        <div class="header-actions">
            <button mat-stroked-button (click)="exportReport()">
                <mat-icon>file_download</mat-icon>
                Export Report
            </button>
            <button mat-flat-button color="primary" routerLink="/students/student-form" [queryParams]="{ type: 'student' }">
                <mat-icon>person_add</mat-icon>
                New Student
            </button>
        </div>
    </header>

    <div class="stats-grid">
        <mat-card *ngFor="let stat of stats" class="stat-card">
            <mat-card-content>
                <div class="stat-icon" [style.background-color]="stat.color + '15'" [style.color]="stat.color">
                    <mat-icon>{{stat.icon}}</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="label">{{stat.label}}</span>
                    <h2 class="value">{{stat.value}}</h2>
                    <span class="trend" [class.positive]="stat.trend.startsWith('+')">
                        {{stat.trend}} <small>vs last month</small>
                    </span>
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <div class="dashboard-grid">
        <mat-card class="chart-card glass-panel">
            <mat-card-header>
                <mat-card-title>Floor-wise Occupancy</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-placeholder">
                    <div class="bars">
                        <div class="bar-container" *ngFor="let floor of allocationSummary">
                             <div class="bar" [style.height.%]="floor.percentage" [title]="'Floor ' + floor.floorNumber + ': ' + floor.percentage + '%'"></div>
                             <span class="bar-label">F{{floor.floorNumber}}</span>
                        </div>
                    </div>
                    <p>Occupancy percentage per floor</p>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="activity-card glass-panel">
            <mat-card-header>
                <mat-card-title>Leaving Soon</mat-card-title>
                <mat-card-subtitle>Students leaving in next 30 days</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <div class="empty-state" *ngIf="studentsLeavingSoon.length === 0">
                     <mat-icon>check_circle</mat-icon>
                     <p>No departures scheduled recently.</p>
                </div>
                <mat-list>
                    <mat-list-item *ngFor="let student of studentsLeavingSoon">
                        <mat-icon matListItemIcon style="color: #6366f1">flight_takeoff</mat-icon>
                        <div matListItemTitle class="font-bold cursor-pointer hover:text-primary transition-colors" (click)="viewRoom(student)">
                            {{student.studentName}}
                        </div>
                        <div matListItemLine>Room: <span class="highlight">{{student.roomNumber}}</span> | <span [style.color]="student.daysLeft < 7 ? 'red' : 'inherit'">{{student.daysLeft}} days left</span></div>
                    </mat-list-item>
                </mat-list>
            </mat-card-content>
        </mat-card>

        <mat-card class="activity-card glass-panel">
            <mat-card-header>
                <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                    <div>
                        <mat-card-title>Upcoming & Due Payments</mat-card-title>
                        <mat-card-subtitle>Payments due within 10 days</mat-card-subtitle>
                    </div>
                    <button mat-icon-button routerLink="/payments" matTooltip="View All">
                        <mat-icon>arrow_forward</mat-icon>
                    </button>
                </div>
            </mat-card-header>
            <mat-card-content>
                <div class="empty-state" *ngIf="upcomingPayments.length === 0">
                    <mat-icon>check_circle</mat-icon>
                    <p>All payments are up to date!</p>
                </div>
                <mat-list>
                    <mat-list-item *ngFor="let pay of upcomingPayments">
                        <mat-icon matListItemIcon [style.color]="pay.isOverdue ? '#ef4444' : '#f59e0b'">
                            {{pay.isOverdue ? 'error' : 'warning'}}
                        </mat-icon>
                        <div matListItemTitle [style.color]="pay.isOverdue ? '#ef4444' : 'inherit'" style="font-weight: 600;" class="cursor-pointer" (click)="viewRoom(pay)">
                            {{pay.userName}}
                        </div>
                        <div matListItemLine>
                            Room: <span class="highlight">{{pay.roomNumber}}</span> | Amount: â‚¹{{pay.balance}} | Due in {{pay.daysLeft}} days
                        </div>
                        <div class="payment-date red-mark" *ngIf="pay.isOverdue || pay.daysLeft <= 3">
                            URGENT
                        </div>
                    </mat-list-item>
                </mat-list>
            </mat-card-content>
        </mat-card>
    </div>
</div>